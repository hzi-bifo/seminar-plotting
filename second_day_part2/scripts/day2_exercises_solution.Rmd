---
title: "Day 2 – Exercise Solutions"
author: "Seminar reference solutions"
output:
  html_document:
    toc: true
    toc_depth: 2
---

Use these solutions after the workshop to debrief or double-check the exercises (bonus included).


---


# Solution – Explore Data

Use this key after attempting `scripts/individual_notebooks/01_explore_data_exercises.Rmd`. The code
chunks mirror the TODOs but include one possible solution for each task.

## 1. Load and preview the dataset

```{r s01-ex1-sol}
input_path <- file.path('..', 'data', 'dataset2_subset_long.csv')
long_df <- read.csv(input_path, stringsAsFactors = FALSE, check.names = FALSE)
cat('Rows:', nrow(long_df), '\\nColumns:', ncol(long_df), '\\n')
head(long_df)
```

## 2. Enumerate genomes and SNPs

```{r s01-ex2-sol}
unique(long_df$Genome)

table(long_df$Genome)

tapply(long_df$snp_id, long_df$Genome, function(x) length(unique(x)))
```

## 3. Summaries by genome

```{r s01-ex3-sol}
sample_values <- long_df$value[1:10]
summary(sample_values)

aggregate(value ~ Genome, data = long_df, function(x) summary(x))
```

## 4. Focus on Turicimonas

```{r s01-ex4-sol}
turicimonas_df <- long_df[long_df$Genome == 'Turicimonas_muris_YL45', ]
cat('Rows for Turicimonas:', nrow(turicimonas_df), '\\n')
head(turicimonas_df)

table(turicimonas_df$mouse_id, turicimonas_df$day)
```

## 5. Allele-frequency focus (Turicimonas vs all genomes)

```{r s01-ex5-sol, fig.width=6, fig.height=4}
turicimonas_values <- long_df$value[long_df$Genome == 'Turicimonas_muris_YL45']
hist(turicimonas_values, breaks = 20, main = 'Turicimonas AF', xlab = 'value')
summary(turicimonas_values)
```

```{r s01-ex5b-sol, fig.width=6, fig.height=4}
hist(long_df$value, breaks = 30, main = 'All genomes AF', xlab = 'value')
summary(long_df$value)
```

## 6. Missing values

```{r s01-ex6-na}
na_total <- sum(is.na(long_df$value))
na_total

na_by_mouse_day <- with(long_df, tapply(value, list(mouse_id, day), function(x) sum(is.na(x))))
na_by_mouse_day
```

In this dataset the counts are all zero, so no genome (including Turicimonas)
introduces missing allele-frequency entries.

## 7. Treatment groups

```{r s01-ex7-groups}
unique(long_df$treatment_group)
table(long_df$treatment_group)
table(long_df$mouse_id, long_df$treatment_group)
long_df[long_df$day == 30, c('mouse_id','treatment_group')]
```

## 8. Stretch idea

```{r s01-ex8-sol}
day30 <- long_df[long_df$day == 30, ]
medians_day30 <- tapply(day30$value, day30$Genome, median, na.rm = TRUE)
medians_day30
medians_day30[which.max(medians_day30)]
```

Feel free to compare your answers with these outputs, then proceed to
`scripts/individual_notebooks/02_simple_heatmap.Rmd`.


# Solution – Simple Heatmap

Below is one possible solution for the worksheet that builds the heatmap from
`dataset2_subset.csv` / `dataset2_subset_long.csv` (three genomes). Feel free to
compare this with your own approach.

## 1. Load packages and define paths

```{r s02-setup}
library(ComplexHeatmap)
library(circlize)

subset_path <- file.path('..', 'data', 'dataset2_subset.csv')
long_path <- file.path('..', 'data', 'dataset2_subset_long.csv')
pdf_path <- file.path('..', 'pdf', 'dataset2_heatmap.pdf')
```

## 2. Load/inspect the data

```{r s02-load}
wide_df <- read.csv(subset_path, check.names = FALSE, stringsAsFactors = FALSE)
long_df <- read.csv(long_path, check.names = FALSE, stringsAsFactors = FALSE)

cat('Wide table dimensions:', nrow(wide_df), 'rows x', ncol(wide_df), 'columns\n')
cat('Long table dimensions:', nrow(long_df), 'rows x', ncol(long_df), 'columns\n')

head(wide_df[, c('Genome', 'snp_id', 'Position')])
head(long_df)
```

## 3. Choose a treatment group subset

```{r s02-ex3-groups-sol}
target_group <- 'Control'
sample_meta <- unique(long_df[, c('mouse_id', 'day', 'treatment_group')])
sample_meta$sample_id <- paste(sample_meta$mouse_id, sample_meta$day, sep = '-')
keep_samples <- sample_meta$sample_id[sample_meta$treatment_group == target_group]
wide_df <- wide_df[, c('Genome', 'snp_id', 'Position', keep_samples)]
```

## 4. Quick summaries

```{r s02-summaries}
print(table(wide_df$Genome))

mouse_day_table <- with(long_df, table(mouse_id, day))
print(mouse_day_table)

value_summary <- tapply(long_df$value, long_df$Genome, function(x) {
  c(min = min(x, na.rm = TRUE),
    median = median(x, na.rm = TRUE),
    max = max(x, na.rm = TRUE))
})
value_summary <- do.call(rbind, value_summary)
print(value_summary)
```

## 5. Build the heatmap matrix

```{r s02-matrix}
sample_cols <- setdiff(names(wide_df), c('Genome', 'snp_id', 'Position'))
heatmap_matrix <- as.matrix(wide_df[, sample_cols])
mode(heatmap_matrix) <- 'numeric'
rownames(heatmap_matrix) <- paste(wide_df$Genome, wide_df$snp_id, sep = ' | ')

sample_meta <- data.frame(sample_id = sample_cols, stringsAsFactors = FALSE)
split_ids <- strsplit(sample_meta$sample_id, '-', fixed = TRUE)
sample_meta$mouse_id <- vapply(split_ids, function(x) x[[1]], character(1))
sample_meta$day <- as.integer(vapply(split_ids, function(x) if (length(x) >= 2) x[[2]] else NA_character_, character(1)))

order_idx <- order(sample_meta$mouse_id, sample_meta$day, sample_meta$sample_id)
sample_meta <- sample_meta[order_idx, ]
heatmap_matrix <- heatmap_matrix[, sample_meta$sample_id, drop = FALSE]
```

## 6. Colors and annotations

```{r s02-colors}
min_val <- min(heatmap_matrix, na.rm = TRUE)
max_val <- max(heatmap_matrix, na.rm = TRUE)
if (!is.finite(min_val)) min_val <- 0
if (!is.finite(max_val)) max_val <- 1
if (abs(max_val - min_val) < .Machine$double.eps) {
  max_val <- min_val + 1
}
mid_val <- (min_val + max_val) / 2
color_fun <- circlize::colorRamp2(c(min_val, mid_val, max_val),
                                  c('#0c2c84', '#f7fbff', '#b30000'))

mouse_levels <- unique(sample_meta$mouse_id)
mouse_colors <- setNames(grDevices::rainbow(length(mouse_levels)), mouse_levels)

min_day <- min(sample_meta$day, na.rm = TRUE)
max_day <- max(sample_meta$day, na.rm = TRUE)
if (min_day == max_day) {
  day_colors <- circlize::colorRamp2(c(min_day, min_day + 1), c('#fee8c8', '#e34a33'))
} else {
  day_colors <- circlize::colorRamp2(seq(min_day, max_day, length.out = 3),
                                     c('#fee8c8', '#fdbb84', '#e34a33'))
}

col_annotation <- HeatmapAnnotation(
  mouse = factor(sample_meta$mouse_id, levels = mouse_levels),
  day = sample_meta$day,
  col = list(mouse = mouse_colors, day = day_colors),
  annotation_name_side = 'left'
)
```

## 7. Draw and export the heatmap

```{r s02-draw, fig.width=10, fig.height=8}
row_name_size <- max(5, min(8, 40 / log10(max(10, nrow(heatmap_matrix)))))
col_name_size <- max(6, min(10, 80 / ncol(heatmap_matrix)))

ht <- Heatmap(
  heatmap_matrix,
  name = 'value',
  col = color_fun,
  na_col = '#f0f0f0',
  top_annotation = col_annotation,
  column_split = factor(sample_meta$mouse_id, levels = mouse_levels),
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  column_title = 'Mouse x day samples',
  row_title = 'Genome | SNP',
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_names_gp = grid::gpar(fontsize = row_name_size),
  column_names_gp = grid::gpar(fontsize = col_name_size)
)

draw(ht, heatmap_legend_side = 'right', annotation_legend_side = 'right')

pdf_height <- max(6, min(18, 0.2 * nrow(heatmap_matrix) + 4))
pdf_width <- max(8, min(16, 0.2 * ncol(heatmap_matrix) + 6))

dir.create(dirname(pdf_path), recursive = TRUE, showWarnings = FALSE)
pdf(pdf_path, width = pdf_width, height = pdf_height)
draw(ht, heatmap_legend_side = 'right', annotation_legend_side = 'right')
dev.off()
cat('Saved heatmap to', pdf_path, '\n')
```

For extra practice, try adding `row_split` by Genome or experiment with a
different color palette.


# Solution – Full Heatmap

This solution notebook offers one way to complete the full heatmap exercise.
Feel free to tweak palettes, ordering, or filtering thresholds to suit your
teaching needs.

## 1. Packages, paths, helpers

```{r s04-setup, message=FALSE}
suppressPackageStartupMessages({
  library(ComplexHeatmap)
  library(circlize)
  library(viridisLite)
})
subset_path <- file.path('..','data','dataset3_subset.csv')
long_path   <- file.path('..','data','dataset3_subset_long.csv')
pdf_path    <- file.path('..','pdf','04_full_heatmap_exercise.pdf')
na_color <- '#dcdcdc'
```

## 2. Load data and NA report

```{r s04-load-data}
wide_df <- read.csv(subset_path, check.names = FALSE, stringsAsFactors = FALSE)
long_df <- read.csv(long_path, check.names = FALSE, stringsAsFactors = FALSE)
cat('Wide rows x cols:', nrow(wide_df), ncol(wide_df), '\n')
cat('Long rows x cols:', nrow(long_df), ncol(long_df), '\n')

na_total <- sum(is.na(long_df$value))
cat('NA count (value):', na_total, '\n')
if (na_total > 0) {
  na_table <- with(long_df, tapply(value, list(mouse_id, day), function(x) sum(is.na(x))))
  print(na_table)
}
```

## 3. Matrix + metadata

```{r s04-matrix}
sample_cols <- setdiff(names(wide_df), c('Genome','snp_id','Position'))
mat <- as.matrix(wide_df[, sample_cols])
mode(mat) <- 'numeric'
rownames(mat) <- paste(wide_df$Genome, wide_df$snp_id, sep = ' | ')

sample_meta <- unique(long_df[, c('mouse_id','day','treatment_group')])
sample_meta$sample_id <- paste(sample_meta$mouse_id, sample_meta$day, sep='-')
sample_meta <- sample_meta[match(colnames(mat), sample_meta$sample_id), ]
stopifnot(identical(colnames(mat), sample_meta$sample_id))
```

## 4. Baseline heatmap + palettes

```{r s04-palettes, fig.width=9, fig.height=5}
mins <- min(mat, na.rm = TRUE)
maxs <- max(mat, na.rm = TRUE)
mids <- (mins + maxs) / 2
palette_blue_red <- circlize::colorRamp2(c(mins, mids, maxs), c('#0c2c84','#f7fbff','#b30000'))
palette_viridis <- circlize::colorRamp2(c(mins, mids, maxs), viridisLite::viridis(3))

ht_blue <- Heatmap(mat, name = 'value', col = palette_blue_red, na_col = na_color,
                   cluster_rows = FALSE, cluster_columns = FALSE,
                   show_row_names = FALSE, show_column_names = FALSE)
ht_viridis <- Heatmap(mat, name = 'value', col = palette_viridis, na_col = na_color,
                      cluster_rows = FALSE, cluster_columns = FALSE,
                      show_row_names = FALSE, show_column_names = FALSE)

ht_blue
ht_viridis
```

## 5. Annotations + ordering

```{r s04-annotate, fig.width=10, fig.height=6}
sample_meta$post_ab <- ifelse(sample_meta$day == 0, 'baseline', 'post')
col_ann <- HeatmapAnnotation(
  treatment = sample_meta$treatment_group,
  status = sample_meta$post_ab,
  annotation_name_side = 'left'
)
order_idx <- order(sample_meta$mouse_id, sample_meta$day)
mat_ordered <- mat[, order_idx]
col_ann_ordered <- col_ann[order_idx]

Heatmap(
  mat_ordered,
  name = 'value',
  col = palette_blue_red,
  top_annotation = col_ann_ordered,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = FALSE,
  na_col = na_color
)
```

## 6. Annotation enhancements

```{r s04-annotate-advanced, fig.width=10, fig.height=6}
treatment_levels <- unique(sample_meta$treatment_group)
treatment_cols <- grDevices::hcl.colors(length(treatment_levels), palette = "Set2")
names(treatment_cols) <- treatment_levels
status_cols <- c(baseline = '#4daf4a', post = '#984ea3')
day_col_fun <- circlize::colorRamp2(range(sample_meta$day), c('#f7fbff','#084594'))
col_ann_rich <- HeatmapAnnotation(
  treatment = anno_simple(sample_meta$treatment_group, col = treatment_cols),
  status = anno_simple(sample_meta$post_ab, col = status_cols),
  day = anno_simple(sample_meta$day, col = day_col_fun),
  mouse = anno_text(sample_meta$mouse_id, rot = 90, gp = grid::gpar(fontsize = 6)),
  annotation_name_side = 'left'
)
col_ann_rich_ordered <- col_ann_rich[order_idx]
column_split <- factor(sample_meta$treatment_group[order_idx], levels = treatment_levels)
row_split <- factor(wide_df$Genome, levels = unique(wide_df$Genome))
row_titles <- sub('_.*', '', levels(row_split))

Heatmap(
  mat_ordered,
  name = 'value',
  col = palette_blue_red,
  top_annotation = col_ann_rich_ordered,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  column_split = column_split,
  show_row_names = FALSE,
  show_column_names = FALSE,
  na_col = na_color,
  row_split = row_split,
  row_title = row_titles,
  row_title_gp = grid::gpar(fontsize = 9)
)
```

## 7. Row variance filter

```{r s04-variance, fig.width=10, fig.height=6}
row_var <- apply(mat, 1, var, na.rm = TRUE)
keep_idx <- order(row_var, decreasing = TRUE)[seq_len(min(100, nrow(mat)))]
mat_topvar <- mat[keep_idx, order_idx]
row_split_top <- droplevels(row_split[keep_idx])
Heatmap(
  mat_topvar,
  name = 'value',
  col = palette_blue_red,
  top_annotation = col_ann_rich_ordered,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  column_split = column_split,
  show_row_names = FALSE,
  show_column_names = FALSE,
  na_col = na_color,
  row_split = row_split_top,
  row_title_gp = grid::gpar(fontsize = 9)
)
```

## 8. Final heatmap + PDF export

```{r s04-final, fig.width=10, fig.height=6}
ht_final <- Heatmap(
  mat_ordered,
  name = 'value',
  col = palette_blue_red,
  top_annotation = col_ann_rich_ordered,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  column_split = column_split,
  show_row_names = FALSE,
  show_column_names = FALSE,
  na_col = na_color,
  row_split = row_split,
  row_title = row_titles,
  row_title_gp = grid::gpar(fontsize = 9),
  column_title = 'All genomes (dataset3)'
)
draw(ht_final)
```

```{r s04-export, eval=FALSE}
pdf(pdf_path, width = 11, height = 7)
draw(ht_final)
dev.off()
cat('Saved heatmap to', pdf_path, '\n')
```

## 9. Notes

- Palette choice: the blue-white-red ramp emphasizes deviations from mid values.
- Column ordering by mouse/day reveals antibiotic pulses more clearly than the
  CSV default.
- Variance filtering is helpful when presenting in class; it trims the figure to
  the most dynamic SNPs and speeds up PDF export.
- Extra annotations (day gradient + mouse labels + row splits) plus column
  splits by treatment mirror the annotation tutorial and keep the story tied to
  the experimental design.


# Solution – Bonus Heatmap Customization

This key demonstrates one way to complete the bonus exercise combining
decorations, legends, and a multi-heatmap layout for the dataset3 tables.

## 1. Setup and metadata

```{r sbonus-bonus-sol-setup}
suppressPackageStartupMessages({
  library(ComplexHeatmap)
  library(circlize)
  library(viridisLite)
  library(grid)
})

subset_path <- file.path('..', 'data', 'dataset3_subset.csv')
long_path   <- file.path('..', 'data', 'dataset3_subset_long.csv')
wide_df <- read.csv(subset_path, check.names = FALSE, stringsAsFactors = FALSE)
long_df <- read.csv(long_path, check.names = FALSE, stringsAsFactors = FALSE)

long_df$sample_id <- paste(long_df$mouse_id, long_df$day, sep = '-')
sample_meta <- unique(long_df[, c('sample_id', 'mouse_id', 'day', 'treatment_group')])
sample_meta$day <- as.integer(sample_meta$day)

# Compare two treatment groups for this exercise
target_groups <- c('Control', 'Ciprofloxacin')
sample_meta <- sample_meta[sample_meta$treatment_group %in% target_groups, ]
order_idx <- order(sample_meta$treatment_group, sample_meta$mouse_id, sample_meta$day)
sample_meta <- sample_meta[order_idx, ]
row.names(sample_meta) <- NULL
```

## 2. Matrix, row variance, and palette

```{r sbonus-bonus-sol-matrix}
sample_cols <- sample_meta$sample_id
wide_subset <- wide_df[, c('Genome', 'snp_id', 'Position', sample_cols)]
heatmap_matrix <- as.matrix(wide_subset[, sample_cols])
mode(heatmap_matrix) <- 'numeric'
rownames(heatmap_matrix) <- paste(wide_subset$Genome, wide_subset$snp_id, sep = ' | ')
row_genome <- wide_subset$Genome
row_var <- apply(heatmap_matrix, 1, var, na.rm = TRUE)

value_range <- range(heatmap_matrix, na.rm = TRUE)
color_fun <- circlize::colorRamp2(
  seq(value_range[1], value_range[2], length.out = 5),
  viridisLite::viridis(5)
)
```

## 3. Annotation summaries

```{r sbonus-bonus-sol-annotation-summary}
print(table(sample_meta$treatment_group))
print(table(sample_meta$treatment_group, sample_meta$day))
head(sample_meta)
```

## 4. Column and row annotations

```{r sbonus-bonus-sol-annotations}
treatment_colors <- setNames(c('#1b9e77', '#d95f02'), target_groups)
day_seq <- seq(min(sample_meta$day), max(sample_meta$day), length.out = 5)
day_colors <- circlize::colorRamp2(day_seq, viridisLite::viridis(5))

col_ann <- HeatmapAnnotation(
  treatment = factor(sample_meta$treatment_group, levels = target_groups),
  day = sample_meta$day,
  col = list(treatment = treatment_colors, day = day_colors),
  annotation_name_side = 'left'
)

genome_levels <- unique(row_genome)
genome_colors <- setNames(grDevices::rainbow(length(genome_levels)), genome_levels)
row_ann <- rowAnnotation(
  genome = factor(row_genome, levels = genome_levels),
  col = list(genome = genome_colors),
  annotation_name_side = 'top'
)

preview_mat <- matrix(0, nrow = 1, ncol = ncol(heatmap_matrix))
preview_ht <- Heatmap(
  preview_mat,
  col = c('0' = '#ffffff'),
  top_annotation = col_ann,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_heatmap_legend = FALSE,
  show_row_names = FALSE,
  show_column_names = FALSE,
  column_title = 'Annotation preview'
)

draw(preview_ht, annotation_legend_side = 'right')

row_preview <- Heatmap(
  matrix(0, nrow = nrow(heatmap_matrix), ncol = 1),
  col = c('0' = '#ffffff'),
  right_annotation = row_ann,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = FALSE,
  show_heatmap_legend = FALSE,
  column_title = 'Row annotation preview'
)

draw(row_preview, heatmap_legend_side = 'right', annotation_legend_side = 'right')
```

## 5. Heatmap for high-variance rows

```{r sbonus-bonus-sol-decoration, fig.width=10, fig.height=7}
high_var_cut <- quantile(row_var, 0.9, na.rm = TRUE)
highlight_rows <- which(row_var >= high_var_cut)

main_ht <- Heatmap(
  heatmap_matrix,
  name = 'bonus_heatmap',
  col = color_fun,
  top_annotation = col_ann,
  right_annotation = row_ann,
  column_split = factor(sample_meta$treatment_group, levels = target_groups),
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  column_title = 'Control vs Ciprofloxacin',
  heatmap_legend_param = list(title = 'Allele frequency'),
  na_col = '#f0f0f0'
)
```

## 6. Companion heatmap, custom legend, and draw call

```{r sbonus-bonus-sol-heatmap-list, fig.width=11, fig.height=7}
control_cols <- sample_meta$sample_id[sample_meta$treatment_group == target_groups[1]]
treated_cols <- sample_meta$sample_id[sample_meta$treatment_group == target_groups[2]]
control_mean <- rowMeans(heatmap_matrix[, control_cols, drop = FALSE], na.rm = TRUE)
treated_mean <- rowMeans(heatmap_matrix[, treated_cols, drop = FALSE], na.rm = TRUE)
mean_delta <- treated_mean - control_mean

delta_ht <- Heatmap(
  mean_delta,
  name = 'Δ mean',
  width = unit(1.2, 'cm'),
  col = circlize::colorRamp2(
    c(min(mean_delta, na.rm = TRUE), 0, max(mean_delta, na.rm = TRUE)),
    c('#4575b4', '#f7f7f7', '#d73027')
  ),
  show_row_names = FALSE,
  cluster_rows = FALSE,
  heatmap_legend_param = list(title = 'Mean difference'),
  column_title = 'Cipro - Control'
)

combo <- main_ht + delta_ht
highlight_legend <- Legend(
  title = 'Highlight',
  labels = 'Row variance ≥ 90th pct',
  legend_gp = gpar(fill = '#ffe0b2', col = '#ff9500', lwd = 1.2)
)
combo <- draw(
  combo,
  heatmap_legend_side = 'right',
  annotation_legend_side = 'right',
  heatmap_legend_list = list(highlight_legend)
)
```

## 7. Notes

```{r sbonus-bonus-sol-notes}
cat('Highlighted rows:', length(highlight_rows), '\n')
cat('Top genomes in highlight:\n')
print(sort(table(row_genome[highlight_rows]), decreasing = TRUE))
```

The decoration makes it obvious that the most variable SNPs mostly belong to the
Akkermansia genome in this subset, and the companion Δ-mean heatmap shows where
Ciprofloxacin drives allele-frequency changes relative to Control.
